/**
 * UPDATED Google Apps Script for Anabina Construction
 * Handles creating, retrieving, and updating document records, now including Client Email and Phone.
 */

const SHEET_NAME = "All_Documents";

// This function runs when the web app sends a GET request (on page load)
function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      // If the sheet doesn't exist, create it with the correct headers.
      const newSheet = SpreadsheetApp.getActiveSpreadsheet().insertSheet(SHEET_NAME);
      newSheet.appendRow([
        "Timestamp", "DocumentType", "DocumentNumber", "DocumentDate", "DueDate",
        "ClientName", "ClientCompany", "ClientAddress", "ClientEmail", "ClientPhone",
        "ItemsJSON", "Subtotal", "TaxRate", "TaxAmount", "TotalAmount", "Notes"
      ]);
      // Return empty data since the sheet was just created
      return ContentService
        .createTextOutput(JSON.stringify({ status: "success", data: [] }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Get all data from the sheet, except the header row
    const data = sheet.getDataRange().getValues();
    const headers = data.shift(); // Remove header row and get headers
    
    // Convert the 2D array into an array of objects
    const records = data.map((row, index) => {
      let record = {
        // Add 2 to the index because sheet rows are 1-based and we shifted the header
        rowNumber: index + 2 
      };
      headers.forEach((header, i) => {
        record[header] = row[i];
      });
      return record;
    });

    return ContentService
      .createTextOutput(JSON.stringify({ status: "success", data: records }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log(error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// This function runs when the web app sends a POST request (on save)
function doPost(e) {
  try {
    const request = JSON.parse(e.postData.contents);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      throw new Error(`Sheet "${SHEET_NAME}" not found. Please reload the app to create it.`);
    }

    // Prepare the data row in the correct column order
    const dataRow = [
      new Date(), // Timestamp
      request.data.documentType,
      request.data.documentNumber,
      request.data.documentDate,
      request.data.dueDate,
      request.data.clientName,
      request.data.clientCompany,
      request.data.clientAddress,
      request.data.clientEmail,   // ADDED
      request.data.clientPhone,   // ADDED
      JSON.stringify(request.data.items),
      request.data.subtotal,
      request.data.taxRate,
      request.data.taxAmount,
      request.data.totalAmount,
      request.data.notes
    ];

    if (request.action === 'update' && request.rowNumber) {
      // Update existing row
      sheet.getRange(request.rowNumber, 1, 1, dataRow.length).setValues([dataRow]);
      return ContentService
        .createTextOutput(JSON.stringify({ status: "success", message: "Document updated successfully." }))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      // Create new row
      sheet.appendRow(dataRow);
      return ContentService
        .createTextOutput(JSON.stringify({ status: "success", message: "Document saved successfully." }))
        .setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log(error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
